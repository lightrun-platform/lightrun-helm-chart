name: Commit Message Check
trigger: none  # No trigger on push; only runs on PRs

pr:
  branches:
    include:
      - main
  autoCancel: true

pool:
  vmImage: 'ubuntu-latest'

steps:
  - checkout: self
    fetchDepth: 0  # Ensure full commit history for validation

  - script: |
      # Define allowed commit message regex
      COMMIT_REGEX="^(?:([A-Z]+-[0-9]+)-)?([^-]+)-(.+)$"
      ALLOWED_TYPES="added versions changed deprecated removed fixed security docs other"

      # Get PR details
      PR_ID=$(System.PullRequest.PullRequestId)
      PROJECT=$(System.TeamProject)
      REPO=$(Build.Repository.Name)
      ORG_URL=$(System.CollectionUri)
      PR_TITLE=$(System.PullRequest.Title)

      if [ -z "$PR_ID" ]; then
        echo "❌ This pipeline should only run on PRs."
        exit 1
      fi

      echo "Checking PR #$PR_ID in repo $REPO"
      echo "PR Title: $PR_TITLE"

      # Get PR labels using Azure DevOps API
      LABELS=$(curl -s --header "Authorization: Bearer $(System.AccessToken)" \
                      --header "Content-Type: application/json" \
                      "$ORG_URL$PROJECT/_apis/git/repositories/$REPO/pullRequests/$PR_ID/labels?api-version=6.0")

      if [ -z "$LABELS" ] || [[ "$LABELS" == *"html"* ]]; then
        echo "⚠️ Warning: Could not retrieve labels, skipping check."
      elif echo "$LABELS" | jq -r '.value[].name' | grep -q "skip-commit-check"; then
        echo "✅ Skipping PR title validation due to 'skip-commit-check' label."
        exit 0
      fi

      # Validate PR title
      if ! [[ "$PR_TITLE" =~ $COMMIT_REGEX ]]; then
        echo "❌ PR title does not match pattern: $PR_TITLE"
        echo "Expected format: [JIRA-ID-]type-description"
        echo "Example: DEVOPS-123-added-new-feature"
        echo "Allowed types: $ALLOWED_TYPES"
        exit 1
      fi

      # Extract Type and validate it
      TYPE=$(echo "$PR_TITLE" | sed -E "s/$COMMIT_REGEX/\2/")
      if ! echo "$ALLOWED_TYPES" | grep -qw "$TYPE"; then
        echo "❌ PR title type '$TYPE' is not allowed. Allowed types: $ALLOWED_TYPES"
        exit 1
      fi

      echo "✅ PR title is valid and follows the required format."
    displayName: "Validate PR Title"
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
